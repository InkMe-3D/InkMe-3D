name: ğŸš€ Sync folders to deploy branches

on:
  push:
    branches:
      - main
    paths:
      - "admin/**"
      - "client/**"
      - "server/**"
      - "3d-custom/**"

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        folder: [admin, client, server, 3d-custom]

    steps:
      - name: â¬‡ï¸ Checkout main
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: ğŸšš Sync ${{ matrix.folder }} to ${{ matrix.folder }} branch
        run: |
          FOLDER=${{ matrix.folder }}
          BRANCH=$FOLDER

          echo "ğŸ“¦ Syncing folder '$FOLDER' to branch '$BRANCH'"

          # Check if folder exists
          if [ ! -d "$FOLDER" ]; then
            echo "âŒ Folder '$FOLDER' not found in branch 'main'."
            exit 1
          fi

          # Copy folder content to temp location outside git working dir
          cp -r "$FOLDER" "/tmp/temp-folder"

          # Fetch & checkout target branch
          git fetch origin
          if git show-ref --verify --quiet refs/remotes/origin/$BRANCH; then
            echo "âœ… Branch $BRANCH exists. Checking out..."
            git checkout -B "$BRANCH" "origin/$BRANCH"
          else
            echo "ğŸ†• Branch $BRANCH does not exist. Creating..."
            git checkout -b "$BRANCH"
          fi

          # Remove all files except .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Move files from temp folder into current branch
          cp -r /tmp/temp-folder/. ./
          rm -rf /tmp/temp-folder

          # ğŸ‘‰ Náº¿u Ä‘ang sync folder 3d-custom, thay Ä‘á»•i URL API
          if [ "$FOLDER" = "3d-custom" ]; then
          echo "ğŸ”§ Replacing API URL in 3d-custom files..."
           find . -type f \( -name "*.js" -o -name "*.html" \) -exec \
          sed -i 's|http://localhost:4000|https://inkme-3d-server-production.up.railway.app|g' {} +
           echo "âœ… Replaced API base URL for deploy"
          fi

          # Commit and push if there are changes
          git add .
          git diff --cached --quiet || git commit -m "ğŸ” Sync from main: $FOLDER"
          git push origin "$BRANCH"

      - name: âœ… Done
        run: echo "âœ… All done syncing ${{ matrix.folder }}!"
